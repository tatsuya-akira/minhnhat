<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="title">Mô phỏng Hệ sinh thái Cần Giờ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        body {
            font-family: 'Inter', sans-serif;
            background: #0B1120;
            color: #e2e8f0;
            overscroll-behavior: none;
        }
        .control-panel, .chart-container {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .canvas-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            background-color: #0c4a6e;
        }
        #ecosystemCanvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
            transition: background-color 1s ease;
        }
        .btn {
            padding: 0.6rem 1rem; 
            border-radius: 0.5rem; 
            font-weight: 600;
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center;
            justify-content: center; 
            gap: 0.5rem;
            border: 1px solid transparent;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            background-color: #475569 !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        .btn:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); 
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #e2e8f0;
            background-color: rgba(59, 130, 246, 0.2);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .lang-btn {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            background-color: #334155;
            transition: background-color 0.2s;
        }
        .lang-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .notification {
            padding: 1rem;
            border-radius: 0.75rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeIn 0.5s ease-out forwards;
        }
        .notification.fade-out {
            animation: fadeOut 0.5s ease-in forwards;
        }
        .notification-info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .notification-success { background: linear-gradient(135deg, #16a34a, #15803d); }
        .notification-warning { background: linear-gradient(135deg, #f97316, #ea580c); }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="w-full max-w-screen-2xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-white" data-translate="header">Mô phỏng Quản lý Hệ sinh thái Cần Giờ</h1>
            <div class="flex items-center gap-2">
                <span data-translate="language" class="hidden md:inline">Ngôn ngữ:</span>
                <div id="language-switcher" class="flex gap-1 bg-slate-700 p-1 rounded-lg">
                    <button class="lang-btn active" data-lang="vi">VI</button>
                    <button class="lang-btn" data-lang="en">EN</button>
                    <button class="lang-btn" data-lang="ja">JA</button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            <!-- Left Column: Canvas and Charts -->
            <div class="xl:col-span-3 flex flex-col gap-6">
                <div class="canvas-container">
                    <canvas id="ecosystemCanvas"></canvas>
                    <div id="season-indicator" class="absolute top-4 left-4 text-white text-xl font-bold p-2 rounded-lg bg-black/40 backdrop-blur-sm"></div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="chart-container p-4"><canvas id="populationChart"></canvas></div>
                    <div class="chart-container p-4"><canvas id="carbonChart"></canvas></div>
                </div>
            </div>

            <!-- Right Column: Control Panel -->
            <div class="xl:col-span-1">
                <div class="control-panel p-5 sticky top-6">
                    <div class="text-center mb-4">
                        <p><i class="fas fa-calendar-alt mr-2 text-amber-300"></i><span data-translate="day">Ngày</span>: <span id="day-count" class="font-bold text-amber-300">0</span></p>
                        <p class="text-3xl font-bold text-green-400 mt-1">$<span id="money-count">1000</span></p>
                    </div>

                    <div class="flex border-b border-slate-600 mb-4 text-sm">
                        <button class="tab-btn flex-1 p-3 text-slate-300 border-b-2 border-transparent hover:bg-slate-700 active" data-tab="stats" data-translate="stats_tab">Thống kê</button>
                        <button class="tab-btn flex-1 p-3 text-slate-300 border-b-2 border-transparent hover:bg-slate-700" data-tab="actions" data-translate="actions_tab">Hành động</button>
                        <button class="tab-btn flex-1 p-3 text-slate-300 border-b-2 border-transparent hover:bg-slate-700" data-tab="guide" data-translate="guide_tab">Hướng dẫn</button>
                        <button class="tab-btn flex-1 p-3 text-slate-300 border-b-2 border-transparent hover:bg-slate-700" data-tab="ai" data-translate="ai_tab">AI</button>
                    </div>

                    <div id="stats-tab" class="tab-content active space-y-3 text-sm">
                        <p><i class="fas fa-water w-5 text-center text-green-400"></i> <span data-translate="algae">Tảo</span>: <span id="plankton-count" class="font-bold text-green-400">0</span></p>
                        <p><i class="fas fa-bug w-5 text-center text-orange-400"></i> <span data-translate="crabs">Cua</span>: <span id="crab-count" class="font-bold text-orange-400">0</span></p>
                        <p><i class="fas fa-fish w-5 text-center text-blue-400"></i> <span data-translate="fish">Cá</span>: <span id="fish-count" class="font-bold text-blue-400">0</span></p>
                        <p><i class="fas fa-paw w-5 text-center text-yellow-500"></i> <span data-translate="monkeys">Khỉ</span>: <span id="monkey-count" class="font-bold text-yellow-500">0</span></p>
                        <p><i class="fas fa-dove w-5 text-center text-sky-300"></i> <span data-translate="birds">Chim</span>: <span id="bird-count" class="font-bold text-sky-300">0</span></p>
                        <p><i class="fas fa-apple-alt w-5 text-center text-red-400"></i> <span data-translate="fruits">Trái cây</span>: <span id="fruit-count" class="font-bold text-red-400">0</span></p>
                        <p><i class="fas fa-tree w-5 text-center text-lime-500"></i> <span data-translate="mangroves">Đước</span>: <span id="mangrove-count" class="font-bold text-lime-500">0</span></p>
                        <p><i class="fas fa-leaf w-5 text-center text-teal-400"></i> <span data-translate="nipa_palms">Dừa nước</span>: <span id="nipa-palm-count" class="font-bold text-teal-400">0</span></p>
                        <hr class="border-slate-600 my-2">
                        <p><i class="fas fa-smog w-5 text-center text-red-500"></i> <span data-translate="pollution">Ô nhiễm</span>: <span id="pollution-level" class="font-bold text-red-500">0</span></p>
                        <p><i class="fas fa-seedling w-5 text-center text-cyan-400"></i> <span data-translate="carbon_credits">Tín chỉ Carbon</span>: <span id="carbon-credits" class="font-bold text-cyan-400">0</span></p>
                    </div>

                    <div id="actions-tab" class="tab-content space-y-3">
                        <h3 class="font-bold text-center text-slate-400" data-translate="add_plants">Thêm Thực vật</h3>
                        <button id="buyMangrove" class="w-full btn bg-green-600 hover:bg-green-500 text-white"><i class="fas fa-tree"></i><span data-translate="buy_mangrove">Trồng Đước ($100)</span></button>
                        <button id="buyNipaPalm" class="w-full btn bg-teal-600 hover:bg-teal-500 text-white"><i class="fas fa-leaf"></i><span data-translate="buy_nipa_palm">Trồng Dừa Nước ($120)</span></button>
                        <hr class="border-slate-600 my-2">
                        <h3 class="font-bold text-center text-slate-400" data-translate="add_animals">Thêm Động vật</h3>
                        <button id="introduceCrabs" class="w-full btn bg-orange-600 hover:bg-orange-500 text-white"><i class="fas fa-bug"></i><span data-translate="introduce_crabs">Thả Cua ($200)</span></button>
                        <button id="introduceFish" class="w-full btn bg-blue-600 hover:bg-blue-500 text-white"><i class="fas fa-fish"></i><span data-translate="introduce_fish">Thả Cá ($250)</span></button>
                        <button id="introduceMonkeys" class="w-full btn bg-yellow-600 hover:bg-yellow-500 text-white"><i class="fas fa-paw"></i><span data-translate="introduce_monkeys">Thả Khỉ ($400)</span></button>
                        <button id="introduceBirds" class="w-full btn bg-sky-500 hover:bg-sky-400 text-white"><i class="fas fa-dove"></i><span data-translate="introduce_birds">Thả Chim ($350)</span></button>
                        <hr class="border-slate-600 my-2">
                        <h3 class="font-bold text-center text-slate-400" data-translate="other_actions">Hành động khác</h3>
                        <button id="callCSR" class="w-full btn bg-indigo-600 hover:bg-indigo-500 text-white"><i class="fas fa-hands-helping"></i><span data-translate="call_csr">Kêu gọi CSR ($500)</span></button>
                        <button id="sellCarbon" class="w-full btn bg-cyan-600 hover:bg-cyan-500 text-white"><i class="fas fa-dollar-sign"></i><span data-translate="sell_carbon">Bán Tín chỉ Carbon</span></button>
                    </div>
                    
                    <div id="guide-tab" class="tab-content space-y-3 text-sm max-h-[50vh] overflow-y-auto pr-2">
                        <h3 class="font-bold text-lg" data-translate="guide_title">Hướng dẫn chơi</h3>
                        <p data-translate="guide_p1"><strong>Mục tiêu:</strong> Xây dựng một hệ sinh thái Cần Giờ cân bằng và thịnh vượng, tối đa hóa tín chỉ carbon và giữ mức ô nhiễm thấp.</p>
                        <p data-translate="guide_p2"><strong>Cách chơi:</strong></p>
                        <ul class="list-disc list-inside space-y-1 pl-2">
                            <li data-translate="guide_li1">Bắt đầu với một số vốn và một vùng đất trống.</li>
                            <li data-translate="guide_li2">Sử dụng tiền để trồng cây (Đước, Dừa nước) để giảm ô nhiễm và tạo tín chỉ carbon.</li>
                            <li data-translate="guide_li3">Khi hệ sinh thái đã có thực vật, hãy thả các loài động vật vào. Mỗi loài có một vai trò riêng.</li>
                            <li data-translate="guide_li4">Cua và Cá ăn Tảo. Khỉ ăn Cua và Trái cây. Chim ăn Cá.</li>
                            <li data-translate="guide_li5">Bán tín chỉ carbon để kiếm thêm tiền.</li>
                            <li data-translate="guide_li6">Kêu gọi CSR (Trách nhiệm xã hội của doanh nghiệp) để giảm mạnh ô nhiễm nhưng tốn nhiều chi phí.</li>
                        </ul>
                        <p data-translate="guide_p3"><strong>Các mùa:</strong> Mỗi mùa kéo dài 100 ngày và ảnh hưởng đến hệ sinh thái. Ví dụ, tảo phát triển nhanh hơn vào mùa hè.</p>
                    </div>

                    <div id="ai-tab" class="tab-content space-y-3 text-sm">
                        <h3 class="font-bold text-lg" data-translate="ai_title">Phân tích từ AI</h3>
                        <div id="ai-analysis-content" class="p-3 bg-slate-800 rounded-lg min-h-[100px] text-cyan-300 italic">
                            <p data-translate="ai_loading">AI đang phân tích dữ liệu...</p>
                        </div>
                    </div>

                    <button id="resetSim" class="w-full mt-6 btn bg-red-600 hover:bg-red-500 text-white"><i class="fas fa-redo"></i> <span data-translate="reset_sim">Chơi lại</span></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notification-container" class="fixed bottom-4 left-4 z-50 space-y-3"></div>

    <script>
        const getEl = (id) => document.getElementById(id);

        // --- Translation Data ---
        const translations = {
            vi: {
                title: "Mô phỏng Hệ sinh thái Cần Giờ", header: "Mô phỏng Quản lý Hệ sinh thái Cần Giờ", language: "Ngôn ngữ",
                day: "Ngày", stats_tab: "Thống kê", actions_tab: "Hành động", guide_tab: "Hướng dẫn", ai_tab: "AI",
                algae: "Tảo", crabs: "Cua", fish: "Cá", monkeys: "Khỉ", birds: "Chim", fruits: "Trái cây", mangroves: "Đước", nipa_palms: "Dừa nước",
                pollution: "Ô nhiễm", carbon_credits: "Tín chỉ Carbon", add_plants: "Thêm Thực vật", buy_mangrove: "Trồng Đước ($100)",
                buy_nipa_palm: "Trồng Dừa Nước ($120)", add_animals: "Thêm Động vật", introduce_crabs: "Thả Cua ($200)", introduce_fish: "Thả Cá ($250)",
                introduce_monkeys: "Thả Khỉ ($400)", introduce_birds: "Thả Chim ($350)", other_actions: "Hành động khác", call_csr: "Kêu gọi CSR ($500)",
                sell_carbon: "Bán Tín chỉ Carbon", guide_title: "Hướng dẫn chơi", guide_p1: "<strong>Mục tiêu:</strong> Xây dựng một hệ sinh thái Cần Giờ cân bằng và thịnh vượng, tối đa hóa tín chỉ carbon và giữ mức ô nhiễm thấp.",
                guide_p2: "<strong>Cách chơi:</strong>", guide_li1: "Bắt đầu với một số vốn và một vùng đất trống.", guide_li2: "Sử dụng tiền để trồng cây (Đước, Dừa nước) để giảm ô nhiễm và tạo tín chỉ carbon.",
                guide_li3: "Khi hệ sinh thái đã có thực vật, hãy thả các loài động vật vào. Mỗi loài có một vai trò riêng.", guide_li4: "Cua và Cá ăn Tảo. Khỉ ăn Cua và Trái cây. Chim ăn Cá.",
                guide_li5: "Bán tín chỉ carbon để kiếm thêm tiền.", guide_li6: "Kêu gọi CSR (Trách nhiệm xã hội của doanh nghiệp) để giảm mạnh ô nhiễm nhưng tốn nhiều chi phí.",
                guide_p3: "<strong>Các mùa:</strong> Mỗi mùa kéo dài 100 ngày và ảnh hưởng đến hệ sinh thái. Ví dụ, tảo phát triển nhanh hơn vào mùa hè.",
                ai_title: "Phân tích từ AI", ai_loading: "AI đang phân tích dữ liệu...", reset_sim: "Chơi lại",
                season_spring: "Mùa Xuân", season_summer: "Mùa Hạ", season_autumn: "Mùa Thu", season_winter: "Mùa Đông",
                ai_analysis_1: "Hệ sinh thái đang phát triển ổn định. Hãy tiếp tục duy trì sự cân bằng.", ai_analysis_2: "Mức độ ô nhiễm đang tăng cao! Hãy trồng thêm cây hoặc thực hiện CSR để giảm thiểu.",
                ai_analysis_3: "Bạn có một lượng lớn tín chỉ carbon. Hãy cân nhắc bán chúng để có thêm vốn đầu tư.", ai_analysis_4: "Số lượng tảo đang giảm nhanh, có thể không đủ thức ăn cho cua và cá. Hãy cẩn thận khi thêm động vật ăn tảo.",
                ai_analysis_5: "Quần thể cua đang phát triển quá mức, có thể gây mất cân bằng. Hãy cân nhắc thả thêm khỉ để kiểm soát.", ai_analysis_6: "Hệ sinh thái thiếu động vật săn mồi top đầu. Thêm chim hoặc khỉ có thể giúp cân bằng chuỗi thức ăn.",
                ai_analysis_7: "Tuyệt vời! Rừng ngập mặn của bạn đang hấp thụ một lượng lớn CO2.", pop_chart_title: "Biểu đồ Quần thể", carbon_chart_title: "Biểu đồ Môi trường",
                pop_chart_crabs: "Cua", pop_chart_fish: "Cá", pop_chart_monkeys: "Khỉ", pop_chart_birds: "Chim", carbon_chart_pollution: "Ô nhiễm", carbon_chart_credits: "Tín chỉ Carbon",
                notif_species_added: "Một loài mới đã được thêm vào hệ sinh thái!", notif_carbon_sold: "Đã bán tín chỉ carbon thành công!", notif_csr_called: "Hoạt động CSR đã giảm ô nhiễm đáng kể.",
                notif_season_change: "Mùa đã thay đổi!", notif_high_pollution: "Cảnh báo: Mức độ ô nhiễm đang ở mức cao!", notif_low_algae: "Cảnh báo: Nguồn tảo đang cạn kiệt!"
            },
            en: {
                title: "Can Gio Ecosystem Simulation", header: "Can Gio Ecosystem Management Simulation", language: "Language",
                day: "Day", stats_tab: "Stats", actions_tab: "Actions", guide_tab: "Guide", ai_tab: "AI",
                algae: "Algae", crabs: "Crabs", fish: "Fish", monkeys: "Monkeys", birds: "Birds", fruits: "Fruits", mangroves: "Mangroves", nipa_palms: "Nipa Palms",
                pollution: "Pollution", carbon_credits: "Carbon Credits", add_plants: "Add Plants", buy_mangrove: "Plant Mangrove ($100)",
                buy_nipa_palm: "Plant Nipa Palm ($120)", add_animals: "Add Animals", introduce_crabs: "Introduce Crabs ($200)", introduce_fish: "Introduce Fish ($250)",
                introduce_monkeys: "Introduce Monkeys ($400)", introduce_birds: "Introduce Birds ($350)", other_actions: "Other Actions", call_csr: "Call for CSR ($500)",
                sell_carbon: "Sell Carbon Credits", guide_title: "How to Play", guide_p1: "<strong>Goal:</strong> Build a balanced and prosperous Can Gio ecosystem, maximizing carbon credits and keeping pollution low.",
                guide_p2: "<strong>Gameplay:</strong>", guide_li1: "Start with some capital and an empty area.", guide_li2: "Use money to plant trees (Mangroves, Nipa Palms) to reduce pollution and generate carbon credits.",
                guide_li3: "Once the ecosystem has plants, introduce animal species. Each species has a unique role.", guide_li4: "Crabs and Fish eat Algae. Monkeys eat Crabs and Fruits. Birds eat Fish.",
                guide_li5: "Sell carbon credits to earn more money.", guide_li6: "Call for CSR (Corporate Social Responsibility) to significantly reduce pollution at a high cost.",
                guide_p3: "<strong>Seasons:</strong> Each season lasts 100 days and affects the ecosystem. For example, algae grows faster in summer.",
                ai_title: "AI Analysis", ai_loading: "AI is analyzing data...", reset_sim: "Reset",
                season_spring: "Spring", season_summer: "Summer", season_autumn: "Autumn", season_winter: "Winter",
                ai_analysis_1: "The ecosystem is developing stably. Keep maintaining the balance.", ai_analysis_2: "Pollution levels are rising! Plant more trees or perform CSR to mitigate.",
                ai_analysis_3: "You have a large amount of carbon credits. Consider selling them for more investment capital.", ai_analysis_4: "Algae population is decreasing rapidly, there might not be enough food for crabs and fish. Be careful when adding more algae-eaters.",
                ai_analysis_5: "The crab population is booming, which may cause imbalance. Consider introducing monkeys to control them.", ai_analysis_6: "The ecosystem lacks top predators. Adding birds or monkeys could help balance the food chain.",
                ai_analysis_7: "Excellent! Your mangrove forest is absorbing a large amount of CO2.", pop_chart_title: "Population Chart", carbon_chart_title: "Environment Chart",
                pop_chart_crabs: "Crabs", pop_chart_fish: "Fish", pop_chart_monkeys: "Monkeys", pop_chart_birds: "Birds", carbon_chart_pollution: "Pollution", carbon_chart_credits: "Carbon Credits",
                notif_species_added: "A new species has been added to the ecosystem!", notif_carbon_sold: "Successfully sold carbon credits!", notif_csr_called: "CSR activity has significantly reduced pollution.",
                notif_season_change: "The season has changed!", notif_high_pollution: "Warning: Pollution level is high!", notif_low_algae: "Warning: Algae source is depleting!"
            },
            ja: {
                title: "カンザー生態系シミュレーション", header: "カンザー生態系管理シミュレーション", language: "言語",
                day: "日目", stats_tab: "統計", actions_tab: "行動", guide_tab: "ガイド", ai_tab: "AI",
                algae: "藻類", crabs: "カニ", fish: "魚", monkeys: "サル", birds: "鳥", fruits: "果物", mangroves: "マングローブ", nipa_palms: "ニッパヤシ",
                pollution: "汚染", carbon_credits: "炭素クレジット", add_plants: "植物を追加", buy_mangrove: "マングローブを植える ($100)",
                buy_nipa_palm: "ニッパヤシを植える ($120)", add_animals: "動物を追加", introduce_crabs: "カニを導入する ($200)", introduce_fish: "魚を導入する ($250)",
                introduce_monkeys: "サルを導入する ($400)", introduce_birds: "鳥を導入する ($350)", other_actions: "その他の行動", call_csr: "CSRを要請 ($500)",
                sell_carbon: "炭素クレジットを売る", guide_title: "遊び方", guide_p1: "<strong>目標:</strong> バランスの取れた豊かなカンザーの生態系を築き、炭素クレジットを最大化し、汚染を低く抑えること。",
                guide_p2: "<strong>ゲームプレイ:</strong>", guide_li1: "資本金と何もないエリアから始めます。", guide_li2: "お金を使って木（マングローブ、ニッパヤシ）を植え、汚染を減らし、炭素クレジットを生成します。",
                guide_li3: "生態系に植物が生えたら、動物を導入します。各種には独自の役割があります。", guide_li4: "カニと魚は藻類を食べます。サルはカニと果物を食べます。鳥は魚を食べます。",
                guide_li5: "炭素クレジットを売って、より多くのお金を稼ぎます。", guide_li6: "CSR（企業の社会的責任）を要請して、高いコストで汚染を大幅に削減します。",
                guide_p3: "<strong>季節:</strong> 各季節は100日間続き、生態系に影響を与えます。例えば、夏には藻類の成長が速くなります。",
                ai_title: "AIによる分析", ai_loading: "AIがデータを分析中...", reset_sim: "リセット",
                season_spring: "春", season_summer: "夏", season_autumn: "秋", season_winter: "冬",
                ai_analysis_1: "生態系は安定して発展しています。バランスを維持し続けてください。", ai_analysis_2: "汚染レベルが上昇しています！木をさらに植えるか、CSRを実施して軽減してください。",
                ai_analysis_3: "大量の炭素クレジットを保有しています。売却して投資資金を増やすことを検討してください。", ai_analysis_4: "藻類の個体数が急激に減少しており、カニや魚の餌が不足する可能性があります。藻類を食べる動物を追加する際は注意してください。",
                ai_analysis_5: "カニの個体数が急増しており、不均衡を引き起こす可能性があります。サルを導入して制御することを検討してください。", ai_analysis_6: "生態系には上位の捕食者が不足しています。鳥やサルを追加すると、食物連鎖のバランスが取れるかもしれません。",
                ai_analysis_7: "素晴らしい！あなたのマングローブ林は大量のCO2を吸収しています。", pop_chart_title: "個体数チャート", carbon_chart_title: "環境チャート",
                pop_chart_crabs: "カニ", pop_chart_fish: "魚", pop_chart_monkeys: "サル", pop_chart_birds: "鳥", carbon_chart_pollution: "汚染", carbon_chart_credits: "クレジット",
                notif_species_added: "新しい種が生態系に追加されました！", notif_carbon_sold: "炭素クレジットの売却に成功しました！", notif_csr_called: "CSR活動により汚染が大幅に減少しました。",
                notif_season_change: "季節が変わりました！", notif_high_pollution: "警告：汚染レベルが高いです！", notif_low_algae: "警告：藻類の資源が枯渇しています！"
            }
        };
        let currentLang = 'vi';

        const ecoCanvas = getEl('ecosystemCanvas'), ecoCtx = ecoCanvas.getContext('2d');
        let populationChart, carbonChart;
        let animationFrameId;

        // --- Game State & Notification Flags ---
        let plankton = [], crabs = [], monkeys = [], mangroves = [], fish = [], birds = [], fruits = [], nipaPalms = [], allShelterTrees = [];
        let money = 1000, carbonCredits = 0, pollutionLevel = 0, gameTime = 0;
        let areCrabsIntroduced = false, areFishIntroduced = false, areMonkeysIntroduced = false, areBirdsIntroduced = false;
        let currentSeason = 'spring';
        let notifiedHighPollution = false, notifiedLowAlgae = false;

        // --- Entity Classes ---
        class Entity {
            constructor(x, y) { this.x = x; this.y = y; this.energy = 100; this.age = 0; }
            update() { this.age++; }
        }
        class Plankton extends Entity { 
            constructor(x, y) { super(x, y); this.energy = 6; } 
            draw(ctx) {
                ctx.fillStyle = 'rgba(134, 239, 172, 0.7)';
                ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fill();
            }
        }
        class Mangrove extends Entity { 
            constructor(x, y) { super(x, y); this.maxAge = 10000; }
            draw(ctx) {
                ctx.fillStyle = '#5D4037'; ctx.fillRect(this.x - 5, this.y, 10, 40);
                ctx.fillStyle = '#2E7D32'; ctx.beginPath(); ctx.arc(this.x, this.y, 25, 0, Math.PI * 2); ctx.fill();
            }
        }
        class NipaPalm extends Entity { 
            constructor(x, y) { super(x, y); this.maxAge = 12000; }
            draw(ctx) {
                ctx.fillStyle = '#A1887F'; ctx.fillRect(this.x - 4, this.y, 8, 35);
                ctx.fillStyle = '#00695C';
                ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x - 30, this.y - 30); ctx.lineTo(this.x - 25, this.y); ctx.fill();
                ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + 30, this.y - 30); ctx.lineTo(this.x + 25, this.y); ctx.fill();
            }
        }
        class Fruit extends Entity { 
            constructor(x, y) { super(x, y); this.energy = 18; }
            draw(ctx) {
                ctx.fillStyle = '#f44336';
                ctx.beginPath(); ctx.arc(this.x, this.y, 5, 0, Math.PI * 2); ctx.fill();
            }
        }
        class Animal extends Entity {
            constructor(x, y, size, color) { super(x, y); this.size = size; this.color = color; }
            draw(ctx) { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
            move() {
                this.x += (Math.random() * 2 - 1) * 2; this.y += (Math.random() * 2 - 1) * 2;
                if (this.x < 0) this.x = ecoCanvas.width; if (this.x > ecoCanvas.width) this.x = 0;
                if (this.y < 0) this.y = ecoCanvas.height; if (this.y > ecoCanvas.height) this.y = 0;
            }
            moveTowards(targets) {
                if (targets.length === 0) { this.move(); return; }
                let nearest = targets.reduce((a, b) => Math.hypot(this.x - a.x, this.y - a.y) < Math.hypot(this.x - b.x, this.y - b.y) ? a : b);
                const dx = nearest.x - this.x, dy = nearest.y - this.y;
                const dist = Math.hypot(dx, dy);
                if (dist > 1) { this.x += (dx / dist) * 1.5; this.y += (dy / dist) * 1.5; }
            }
        }
        const REPRODUCE_RATE = 0.0004;
        const ENERGY_DECAY_LOW = 0.008;
        const ENERGY_DECAY_HIGH = 0.015;
        class Crab extends Animal {
            constructor(x, y) { super(x, y, 8, '#fb923c'); this.maxAge = 1800; }
            update() {
                super.update(); this.moveTowards(plankton); this.energy -= ENERGY_DECAY_LOW;
                plankton.forEach((p, i) => { if (Math.hypot(this.x - p.x, this.y - p.y) < this.size) { this.energy += p.energy; plankton.splice(i, 1); } });
                if (this.energy > 200 && Math.random() < REPRODUCE_RATE) { this.energy -= 100; crabs.push(new Crab(this.x, this.y)); }
            }
        }
        class Fish extends Animal {
            constructor(x, y) { super(x, y, 7, '#60a5fa'); this.maxAge = 1500; }
            update() {
                super.update(); this.moveTowards(plankton); this.energy -= ENERGY_DECAY_LOW;
                plankton.forEach((p, i) => { if (Math.hypot(this.x - p.x, this.y - p.y) < this.size) { this.energy += p.energy; plankton.splice(i, 1); } });
                if (this.energy > 200 && Math.random() < REPRODUCE_RATE) { this.energy -= 100; fish.push(new Fish(this.x, this.y)); }
            }
        }
        class Monkey extends Animal {
            constructor(x, y) { super(x, y, 10, '#facc15'); this.maxAge = 3600; }
            update() {
                super.update(); this.moveTowards([...fruits, ...crabs]); this.energy -= ENERGY_DECAY_HIGH;
                fruits.forEach((f, i) => { if (Math.hypot(this.x - f.x, this.y - f.y) < this.size) { this.energy += f.energy; fruits.splice(i, 1); } });
                crabs.forEach((c, i) => { if (Math.hypot(this.x - c.x, this.y - c.y) < this.size) { this.energy += 20; crabs.splice(i, 1); } });
                if (this.energy > 150 && monkeys.length < 25 && Math.random() < 0.00015) { this.energy -= 100; monkeys.push(new Monkey(this.x, this.y)); }
            }
        }
        class Bird extends Animal {
            constructor(x, y) { super(x, y, 9, '#7dd3fc'); this.maxAge = 3000; }
            update() {
                super.update(); this.moveTowards(fish); this.energy -= ENERGY_DECAY_HIGH;
                fish.forEach((f, i) => { if (Math.hypot(this.x - f.x, this.y - f.y) < this.size) { this.energy += 15; fish.splice(i, 1); } });
                if (this.energy > 120 && birds.length < 35 && Math.random() < 0.0002) { this.energy -= 90; birds.push(new Bird(this.x, this.y)); }
            }
        }

        // --- Game Logic ---
        function init() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);

            ecoCanvas.width = ecoCanvas.offsetWidth;
            ecoCanvas.height = ecoCanvas.offsetHeight;
            
            money = 1000; carbonCredits = 0; pollutionLevel = 0; gameTime = 0;
            plankton = []; crabs = []; monkeys = []; mangroves = []; fish = []; birds = []; fruits = []; nipaPalms = [];
            
            areCrabsIntroduced = false; areFishIntroduced = false; areMonkeysIntroduced = false; areBirdsIntroduced = false;
            notifiedHighPollution = false; notifiedLowAlgae = false;
            document.querySelectorAll('#actions-tab button').forEach(b => b.disabled = false);

            for (let i = 0; i < 3; i++) mangroves.push(new Mangrove(Math.random() * ecoCanvas.width, Math.random() * ecoCanvas.height * 0.8 + ecoCanvas.height * 0.1));
            for (let i = 0; i < 2; i++) nipaPalms.push(new NipaPalm(Math.random() * ecoCanvas.width, Math.random() * ecoCanvas.height * 0.8 + ecoCanvas.height * 0.1));
            allShelterTrees = [...mangroves, ...nipaPalms];
            for (let i = 0; i < 150; i++) plankton.push(new Plankton(Math.random() * ecoCanvas.width, Math.random() * ecoCanvas.height));
            
            initCharts();
            setLanguage(currentLang);
            gameLoop();
        }

        function gameLoop() {
            gameTime++;
            ecoCtx.clearRect(0, 0, ecoCanvas.width, ecoCanvas.height);
            updateSeason();

            let planktonSpawnRate = (currentSeason === 'summer' ? 0.25 : 0.15);
            if (Math.random() < planktonSpawnRate) plankton.push(new Plankton(Math.random() * ecoCanvas.width, Math.random() * ecoCanvas.height));
            
            allShelterTrees.forEach(tree => {
                if (Math.random() < 0.0004 && fruits.length < 50) {
                    fruits.push(new Fruit(tree.x + (Math.random() * 40 - 20), tree.y + (Math.random() * 40 - 20)));
                }
            });

            [plankton, crabs, fish, monkeys, birds, fruits, mangroves, nipaPalms].forEach(arr => {
                for (let i = arr.length - 1; i >= 0; i--) {
                    const entity = arr[i];
                    if (entity.update) entity.update();
                    entity.draw(ecoCtx);
                    if (entity.energy <= 0 || (entity.maxAge && entity.age > entity.maxAge)) arr.splice(i, 1);
                }
            });

            pollutionLevel += 0.01 - (mangroves.length + nipaPalms.length) * 0.002;
            pollutionLevel = Math.max(0, pollutionLevel);
            carbonCredits += (mangroves.length + nipaPalms.length) * 0.005;
            
            updateUI();
            if (gameTime % 60 === 0) updateCharts();
            if (gameTime % (60 * 5) === 1) updateAIAnalysis();
            if (gameTime % (60 * 2) === 2) checkAndNotify();

            animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        function updateUI() {
            getEl('day-count').innerText = Math.floor(gameTime / 60);
            getEl('money-count').innerText = Math.floor(money);
            getEl('plankton-count').innerText = plankton.length;
            getEl('crab-count').innerText = crabs.length;
            getEl('fish-count').innerText = fish.length;
            getEl('monkey-count').innerText = monkeys.length;
            getEl('bird-count').innerText = birds.length;
            getEl('fruit-count').innerText = fruits.length;
            getEl('mangrove-count').innerText = mangroves.length;
            getEl('nipa-palm-count').innerText = nipaPalms.length;
            getEl('pollution-level').innerText = pollutionLevel.toFixed(2);
            getEl('carbon-credits').innerText = carbonCredits.toFixed(2);
        }
        
        function updateSeason() {
            const day = Math.floor(gameTime / 60);
            const seasonLength = 100;
            const seasonIndex = Math.floor(day / seasonLength) % 4;
            const seasonData = {
                spring: { bg: '#0c4a6e', name: 'season_spring' },
                summer: { bg: '#085a87', name: 'season_summer' },
                autumn: { bg: '#0b405e', name: 'season_autumn' },
                winter: { bg: '#0e3a52', name: 'season_winter' }
            };
            
            let newSeason = Object.keys(seasonData)[seasonIndex];

            if (newSeason !== currentSeason) {
                currentSeason = newSeason;
                ecoCanvas.style.backgroundColor = seasonData[currentSeason].bg;
                showNotification('notif_season_change', 'info');
            }
            getEl('season-indicator').innerText = translations[currentLang][seasonData[currentSeason].name];
        }
        
        function updateAIAnalysis() {
            let suggestions = [];
            if (pollutionLevel > 40) suggestions.push('ai_analysis_2');
            if (carbonCredits > 500) suggestions.push('ai_analysis_3');
            if (plankton.length < 50 && (crabs.length > 0 || fish.length > 0)) suggestions.push('ai_analysis_4');
            if (crabs.length > (fish.length + 1) * 2 && areCrabsIntroduced) suggestions.push('ai_analysis_5');
            if (mangroves.length + nipaPalms.length > 20) suggestions.push('ai_analysis_7');
            if (crabs.length + fish.length > 20 && monkeys.length + birds.length === 0) suggestions.push('ai_analysis_6');

            let analysisText = translations[currentLang]['ai_analysis_1'];
            if (suggestions.length > 0) {
                analysisText = translations[currentLang][suggestions[Math.floor(Math.random() * suggestions.length)]];
            }
            getEl('ai-analysis-content').innerHTML = `<p>${analysisText}</p>`;
        }

        function checkAndNotify() {
            if (pollutionLevel > 50 && !notifiedHighPollution) {
                showNotification('notif_high_pollution', 'warning');
                notifiedHighPollution = true;
            } else if (pollutionLevel < 30) {
                notifiedHighPollution = false;
            }

            if (plankton.length < 30 && (areCrabsIntroduced || areFishIntroduced) && !notifiedLowAlgae) {
                showNotification('notif_low_algae', 'warning');
                notifiedLowAlgae = true;
            } else if (plankton.length > 100) {
                notifiedLowAlgae = false;
            }
        }

        function initCharts() {
            const chartOptions = (titleKey) => ({
                scales: { y: { beginAtZero: true, ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } },
                plugins: { 
                    legend: { labels: { color: '#e2e8f0' } },
                    title: { display: true, text: translations[currentLang][titleKey], color: '#e2e8f0', font: { size: 16 } }
                },
                maintainAspectRatio: false
            });
            if (populationChart) populationChart.destroy();
            populationChart = new Chart(getEl('populationChart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [
                    { label: translations[currentLang].pop_chart_crabs, data: [], borderColor: '#fb923c', tension: 0.1 },
                    { label: translations[currentLang].pop_chart_fish, data: [], borderColor: '#60a5fa', tension: 0.1 },
                    { label: translations[currentLang].pop_chart_monkeys, data: [], borderColor: '#facc15', tension: 0.1 },
                    { label: translations[currentLang].pop_chart_birds, data: [], borderColor: '#7dd3fc', tension: 0.1 }
                ]},
                options: chartOptions('pop_chart_title')
            });
            if (carbonChart) carbonChart.destroy();
            carbonChart = new Chart(getEl('carbonChart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [
                    { label: translations[currentLang].carbon_chart_pollution, data: [], borderColor: '#ef4444', tension: 0.1 },
                    { label: translations[currentLang].carbon_chart_credits, data: [], borderColor: '#22d3ee', tension: 0.1 }
                ]},
                options: chartOptions('carbon_chart_title')
            });
        }
        function updateCharts() {
            const day = Math.floor(gameTime / 60);
            const updateChartData = (chart, ...data) => {
                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets.forEach(dataset => dataset.data.shift());
                }
                chart.data.labels.push(day);
                chart.data.datasets.forEach((dataset, i) => dataset.data.push(data[i]));
                chart.update('none');
            };
            updateChartData(populationChart, crabs.length, fish.length, monkeys.length, birds.length);
            updateChartData(carbonChart, pollutionLevel, carbonCredits);
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (translations[lang][key]) {
                    const childSpan = el.querySelector('span');
                    if (childSpan) {
                        const icon = el.querySelector('i');
                        el.innerHTML = (icon ? icon.outerHTML : '') + translations[lang][key];
                    } else {
                        el.innerHTML = translations[lang][key];
                    }
                }
            });
            initCharts();
            updateSeason();
            updateAIAnalysis();
        }
        
        function showNotification(messageKey, type = 'info') {
            const container = getEl('notification-container');
            const notif = document.createElement('div');
            const message = translations[currentLang][messageKey] || messageKey;
            const iconClass = {
                info: 'fas fa-info-circle',
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle'
            };
            notif.className = `notification notification-${type}`;
            notif.innerHTML = `<i class="${iconClass[type]} text-2xl"></i><span>${message}</span>`;
            container.appendChild(notif);
            setTimeout(() => {
                notif.classList.add('fade-out');
                setTimeout(() => notif.remove(), 500);
            }, 5000);
        }

        getEl('language-switcher').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                setLanguage(e.target.dataset.lang);
            }
        });

        getEl('buyMangrove').addEventListener('click', () => { if (money >= 100) { money -= 100; mangroves.push(new Mangrove(Math.random() * ecoCanvas.width, Math.random() * ecoCanvas.height * 0.8 + ecoCanvas.height * 0.1)); allShelterTrees = [...mangroves, ...nipaPalms]; } });
        getEl('buyNipaPalm').addEventListener('click', () => { if (money >= 120) { money -= 120; nipaPalms.push(new NipaPalm(Math.random() * ecoCanvas.width, Math.random() * ecoCanvas.height * 0.8 + ecoCanvas.height * 0.1)); allShelterTrees = [...mangroves, ...nipaPalms]; } });
        getEl('callCSR').addEventListener('click', () => { if (money >= 500) { money -= 500; pollutionLevel = Math.max(0, pollutionLevel - 10); showNotification('notif_csr_called', 'success'); } });
        getEl('sellCarbon').addEventListener('click', () => { if (carbonCredits > 0) { money += carbonCredits * 10; carbonCredits = 0; showNotification('notif_carbon_sold', 'success'); } });

        function introduceSpecies(cost, introductionFlag, spawnFunction, buttonId) {
            if (money >= cost && !window[introductionFlag]) {
                money -= cost;
                spawnFunction();
                window[introductionFlag] = true;
                getEl(buttonId).disabled = true;
                showNotification('notif_species_added', 'success');
            }
        }
        getEl('introduceCrabs').addEventListener('click', () => introduceSpecies(200, 'areCrabsIntroduced', () => { for(let i=0; i<15; i++) crabs.push(new Crab(Math.random()*ecoCanvas.width, Math.random()*ecoCanvas.height)); }, 'introduceCrabs'));
        getEl('introduceFish').addEventListener('click', () => introduceSpecies(250, 'areFishIntroduced', () => { for(let i=0; i<20; i++) fish.push(new Fish(Math.random()*ecoCanvas.width, Math.random()*ecoCanvas.height)); }, 'introduceFish'));
        getEl('introduceMonkeys').addEventListener('click', () => introduceSpecies(400, 'areMonkeysIntroduced', () => { for(let i=0; i<5; i++) monkeys.push(new Monkey(Math.random()*ecoCanvas.width, Math.random()*ecoCanvas.height)); }, 'introduceMonkeys'));
        getEl('introduceBirds').addEventListener('click', () => introduceSpecies(350, 'areBirdsIntroduced', () => { for(let i=0; i<8; i++) birds.push(new Bird(Math.random()*ecoCanvas.width, Math.random()*ecoCanvas.height)); }, 'introduceBirds'));

        getEl('resetSim').addEventListener('click', init);

        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                getEl(button.dataset.tab + '-tab').classList.add('active');
            });
        });

        window.addEventListener('load', init);
        window.addEventListener('resize', () => {
            ecoCanvas.width = ecoCanvas.offsetWidth;
            ecoCanvas.height = ecoCanvas.offsetHeight;
            initCharts();
        });
    </script>
</body>
</html>
